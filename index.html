<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Drag Race Season Simulator</title>
  <link rel="stylesheet" href="style.css" />

  <!-- Card / collapsible styling -->
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #111;
      color: #eee;
      margin: 0;
    }

    .app {
      max-width: 960px;
      margin: 0 auto;
      padding: 1.5rem;
    }

    h1, h2 {
      text-align: center;
      margin-top: 0;
    }

    .controls {
      background: #1b1b1b;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1.5rem;
      box-shadow: 0 0 0 1px #222;
    }

    .control-row {
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    textarea {
      width: 100%;
      font-family: monospace;
      font-size: 0.85rem;
      background: #000;
      color: #eee;
      border-radius: 4px;
      border: 1px solid #444;
      padding: 0.5rem;
      resize: vertical;
    }

    select {
      background: #000;
      color: #eee;
      border-radius: 4px;
      border: 1px solid #444;
      padding: 0.2rem 0.4rem;
    }

    button {
      padding: 0.4rem 0.8rem;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      background: #e91e63;
      color: #fff;
      font-weight: 600;
    }

    button:hover:not(:disabled) {
      filter: brightness(1.1);
    }

    button:disabled {
      opacity: 0.4;
      cursor: default;
    }

    .episode-card {
      background: #161616;
      border-radius: 8px;
      padding: 0.75rem 1rem;
      margin-bottom: 0.75rem;
      box-shadow: 0 0 0 1px #222;
    }

    .header-card {
      border-left: 3px solid #e91e63;
    }

    .finale-card {
      border-left: 3px solid #ffc107;
    }

    details.episode-card > summary {
      cursor: pointer;
      font-weight: 600;
      list-style: none;
    }

    details.episode-card > summary::-webkit-details-marker {
      display: none;
    }

    details.episode-card > summary::before {
      content: "▶";
      display: inline-block;
      margin-right: 0.4rem;
      font-size: 0.8rem;
    }

    details.episode-card[open] > summary::before {
      content: "▼";
    }

    .episode-card pre {
      white-space: pre-wrap;
      font-size: 0.8rem;
      margin: 0.5rem 0 0;
      font-family: Menlo, Consolas, monospace;
    }

    /* Full-view nav row */
    .step-nav {
      margin-top: 0.75rem;
      display: flex;
      justify-content: space-between;
      gap: 0.5rem;
    }

    .step-meta {
      font-size: 0.8rem;
      opacity: 0.8;
      margin-bottom: 0.25rem;
    }
  </style>
</head>
<body>
  <main class="app">
    <h1>Drag Race Season Simulator</h1>

    <section class="controls">
      <div class="control-row">
        <label>
          Mode:
          <select id="modeSelect">
            <option value="normal">Normal</option>
            <option value="chaos">Chaos</option>
          </select>
        </label>

        <label>
          View:
          <select id="viewSelect">
            <option value="summary">Summary</option>
            <option value="full">Full</option>
          </select>
        </label>
      </div>

      <div class="control-row" style="width:100%;">
        <label style="width:100%;">
          Queens JSON:
          <textarea id="queensInput" rows="10" spellcheck="false"></textarea>
        </label>
      </div>

      <div class="control-row">
        <button id="loadDefaultQueens">Load sample cast</button>
        <button id="simulateButton">Simulate Season</button>
      </div>
    </section>

    <section>
      <h2>Season Output</h2>
      <div id="seasonContainer"></div>
    </section>
  </main>

  <!-- Data -->
  <script src="challenges.js"></script>
  <script src="queens.js"></script>

  <!-- Simulator -->
  <script src="sim.js"></script>

  <!-- UI / Rendering -->
  <script>
    const queensInput = document.getElementById("queensInput");
    const modeSelect = document.getElementById("modeSelect");
    const viewSelect = document.getElementById("viewSelect");
    const loadDefaultBtn = document.getElementById("loadDefaultQueens");
    const simulateBtn = document.getElementById("simulateButton");
    const seasonContainer = document.getElementById("seasonContainer");

    // For Full view
    let currentSteps = [];
    let currentStepIndex = 0;

    loadDefaultBtn.addEventListener("click", () => {
      queensInput.value = JSON.stringify(window.QUEENS, null, 2);
    });

    // ---------- Parsing helpers ----------

    function parseSeasonLog(log) {
      const lines = log.split("\n");
      const header = [];
      const episodes = [];
      const finale = [];

      let section = "header";
      let current = null;

      for (const line of lines) {
        if (line.startsWith("========== Episode ")) {
          if (current) episodes.push(current);
          current = { lines: [line] };
          section = "episode";
        } else if (
          line.startsWith("========== Final 3") ||
          line.startsWith("========== Grand Finale")
        ) {
          if (current) episodes.push(current);
          current = null;
          section = "finale";
          finale.push(line);
        } else {
          if (section === "header") header.push(line);
          else if (section === "episode") current.lines.push(line);
          else finale.push(line);
        }
      }
      if (current) episodes.push(current);
      return { header, episodes, finale };
    }

    function filterHeader(lines) {
      const out = [];
      let skip = false;
      for (const l of lines) {
        if (l.startsWith("Planned must-have challenges:")) {
          skip = true;
          continue;
        }
        if (skip) {
          if (l.trim() === "") skip = false;
          continue;
        }
        out.push(l);
      }
      return out.filter(l => l.trim());
    }

    function filterEpisode(lines) {
      const out = [];
      let skip = false;
      for (const l of lines) {
        if (l.startsWith("Scores this week:")) {
          skip = true;
          continue;
        }
        if (skip) {
          if (l.trim() === "") skip = false;
          continue;
        }
        out.push(l);
      }
      return out;
    }

    function filterFinale(lines) {
      const out = [];
      let skip = false;
      for (const l of lines) {
        if (l.startsWith("Final lip sync performance:")) {
          skip = true;
          continue;
        }
        if (skip) {
          if (l.trim() === "") skip = false;
          continue;
        }
        out.push(l);
      }
      return out.filter(l => l.trim());
    }

    // ---------- Summary view rendering ----------

    function renderSeasonSummary(log) {
      seasonContainer.innerHTML = "";
      const { header, episodes, finale } = parseSeasonLog(log);

      const cast = filterHeader(header);
      if (cast.length) {
        const card = document.createElement("div");
        card.className = "episode-card header-card";
        card.innerHTML = `<h3>Cast</h3><pre>${cast.join("\n")}</pre>`;
        seasonContainer.appendChild(card);
      }

      for (const ep of episodes) {
        const lines = filterEpisode(ep.lines);
        const title = lines[0] || "";
        const m = title.match(/Episode (\d+) — (.+?) =+/);
        const label = m ? `Episode ${m[1]} — ${m[2]}` : title;

        const d = document.createElement("details");
        d.className = "episode-card";

        const s = document.createElement("summary");
        s.textContent = label;
        d.appendChild(s);

        const p = document.createElement("pre");
        p.textContent = lines.join("\n");
        d.appendChild(p);

        seasonContainer.appendChild(d);
      }

      if (finale.length) {
        const d = document.createElement("details");
        d.className = "episode-card finale-card";
        d.open = false;

        const s = document.createElement("summary");
        s.textContent = "Grand Finale & Track Records";
        d.appendChild(s);

        const p = document.createElement("pre");
        p.textContent = filterFinale(finale).join("\n");
        d.appendChild(p);

        seasonContainer.appendChild(d);
      }
    }

    // ---------- Full (step-through) view ----------

    function buildStepsFromLog(log) {
      const { header, episodes, finale } = parseSeasonLog(log);
      const steps = [];

      const castLines = filterHeader(header);
      if (castLines.length) {
        steps.push({ type: "cast", lines: castLines });
      }

      episodes.forEach((ep, index) => {
        const filtered = filterEpisode(ep.lines);
        const titleLine = filtered[0] || ep.lines[0] || "";
        const m = titleLine.match(/Episode (\d+) — (.+?) =+/);
        const epNum = m ? parseInt(m[1], 10) : index + 1;
        const epName = m ? m[2] : "Unknown challenge";

        // Setup step (just uses epNum + epName)
        steps.push({ type: "episode_setup", epNum, name: epName });

        // Results step: everything from "Results:" onwards
        const resultsLines = [];
        let inResults = false;
        for (const line of filtered) {
          if (line.startsWith("Results:")) {
            inResults = true;
            resultsLines.push(line);
            continue;
          }
          if (inResults) {
            resultsLines.push(line);
          }
        }
        const cleanResults = resultsLines.filter(l => l.trim() !== "");
        steps.push({
          type: "episode_results",
          epNum,
          name: epName,
          lines: cleanResults
        });
      });

      const finaleLines = filterFinale(finale);
      if (finaleLines.length) {
        const idx = finaleLines.findIndex(l =>
          l.startsWith("========== Grand Finale")
        );
        if (idx > 0) {
          const final3Lines = finaleLines.slice(0, idx).filter(l => l.trim());
          const finaleRest = finaleLines.slice(idx).filter(l => l.trim());
          if (final3Lines.length) steps.push({ type: "final3", lines: final3Lines });
          if (finaleRest.length) steps.push({ type: "finale", lines: finaleRest });
        } else {
          steps.push({ type: "finale", lines: finaleLines });
        }
      }

      return steps;
    }

    function renderCurrentStep() {
      seasonContainer.innerHTML = "";
      if (!currentSteps.length) {
        seasonContainer.textContent = "No steps available.";
        return;
      }
      const step = currentSteps[currentStepIndex];

      const card = document.createElement("div");
      card.className = "episode-card finale-card";

      const meta = document.createElement("div");
      meta.className = "step-meta";
      meta.textContent =
        "Step " + (currentStepIndex + 1) + " of " + currentSteps.length;
      card.appendChild(meta);

      const h = document.createElement("h3");
      let titleText = "";

      let bodyLines = [];

      switch (step.type) {
        case "cast":
          titleText = "Cast Reveal";
          bodyLines = step.lines;
          break;
        case "episode_setup":
          titleText = `Episode ${step.epNum} — ${step.name}`;
          bodyLines = [
            `In Episode ${step.epNum}, the queens face the ${step.name}.`,
            "",
            "Click Proceed to reveal the judging & results..."
          ];
          break;
        case "episode_results":
          titleText = `Episode ${step.epNum} — Judging & Results`;
          bodyLines = step.lines;
          break;
        case "final3":
          titleText = "Final 3 Revealed";
          bodyLines = step.lines;
          break;
        case "finale":
          titleText = "Grand Finale & Track Records";
          bodyLines = step.lines;
          break;
        default:
          titleText = "Season";
          bodyLines = [];
      }

      h.textContent = titleText;
      card.appendChild(h);

      if (bodyLines.length) {
        const p = document.createElement("pre");
        p.textContent = bodyLines.join("\n");
        card.appendChild(p);
      }

      const nav = document.createElement("div");
      nav.className = "step-nav";

      const backBtn = document.createElement("button");
      backBtn.textContent = "Back";
      backBtn.disabled = currentStepIndex === 0;
      backBtn.addEventListener("click", () => {
        if (currentStepIndex > 0) {
          currentStepIndex--;
          renderCurrentStep();
        }
      });

      const nextBtn = document.createElement("button");
      nextBtn.textContent =
        currentStepIndex === currentSteps.length - 1 ? "Restart Season" : "Proceed";
      nextBtn.addEventListener("click", () => {
        if (currentStepIndex === currentSteps.length - 1) {
          currentStepIndex = 0;
        } else {
          currentStepIndex++;
        }
        renderCurrentStep();
      });

      nav.appendChild(backBtn);
      nav.appendChild(nextBtn);
      card.appendChild(nav);

      seasonContainer.appendChild(card);
    }

    function renderSeasonFull(log) {
      currentSteps = buildStepsFromLog(log);
      currentStepIndex = 0;
      renderCurrentStep();
    }

    // ---------- Main simulate handler ----------

    simulateBtn.addEventListener("click", () => {
      const queens = JSON.parse(queensInput.value);
      const mode = modeSelect.value;
      const view = viewSelect.value;

      const log = window.simulateSeason(queens, { mode });

      if (view === "summary") {
        renderSeasonSummary(log);
      } else {
        renderSeasonFull(log);
      }
    });

    // Auto-load sample cast
    window.addEventListener("DOMContentLoaded", () => {
      queensInput.value = JSON.stringify(window.QUEENS, null, 2);
    });
  </script>
</body>
</html>
